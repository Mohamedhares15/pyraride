// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Connects to Neon
}

enum Role {
  rider
  stable_owner
  admin
  cx_media
}

enum GalleryItemStatus {
  pending
  approved
  rejected
}

model GalleryItem {
  id         String            @id @default(uuid())
  url        String
  caption    String?
  status     GalleryItemStatus @default(pending)
  uploadedBy String? // Optional: if we want to track who uploaded it (could be public/anonymous initially)
  reviewedBy String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  reviewer User? @relation("GalleryReviewer", fields: [reviewedBy], references: [id])

  @@index([status])
}

enum Gender {
  male
  female
}

enum LeagueName {
  wood
  bronze
  silver
  gold
  platinum
  elite
  champion
}

enum LeagueStatus {
  active
  ended
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
  rescheduled
}

enum StableStatus {
  pending_approval
  approved
  rejected
}

model Location {
  id        String   @id @default(uuid())
  name      String   @unique // "Giza", "Saqqara"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  phoneNumber        String?   @unique
  passwordHash       String
  profileImageUrl    String?
  profilePhoto       String? // Profile photo URL for chat/friends
  fullName           String?
  bio                String?   @db.Text
  role               Role      @default(rider)
  gender             Gender? // Male or Female
  hasPremiumAI       Boolean   @default(false) // Premium AI subscription (admins can grant to stable owners)
  premiumAIExpiresAt DateTime? // Subscription expiration date
  createdAt          DateTime  @default(now())

  //Multi-Owner Support: A user belongs to a stable
  stableId     String?
  stable       Stable?  @relation("StableOwners", fields: [stableId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  ownedStables Stable[] @relation("StableOwner")

  // Cash Privilege
  isTrustedRider Boolean @default(false)

  //Leaderboard & Ranking
  rankPoints      Int        @default(1000) // Will be set based on initial tier selection
  rankId          String?
  rank            RiderRank? @relation(fields: [rankId], references: [id])
  currentLeagueId String? // Current league the rider is in
  currentLeague   League?    @relation("RiderLeague", fields: [currentLeagueId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Relations
  bookings             Booking[]
  reviews              Review[]
  passwordResetTokens  PasswordResetToken[]
  riderReviewsGiven    RiderReview[]        @relation("StableOwnerReviews")
  riderReviewsReceived RiderReview[]        @relation("RiderReviews")
  horseChangeReviews   HorseChangeRequest[] @relation("HorseChangeReviewer")
  rideResults          RideResult[]
  leagueStandings      LeagueStanding[]
  reviewedGalleryItems GalleryItem[]        @relation("GalleryReviewer")

  // Friends & Chat relations
  friendRequestsSent     Friend[]       @relation("FriendsSent")
  friendRequestsReceived Friend[]       @relation("FriendsReceived")
  messages               Message[]      @relation("MessageSender")
  conversations          Conversation[] @relation("ConversationParticipants")

  // Skill Override Requests
  skillOverrideRequests SkillOverrideRequest[] @relation("RiderSkillRequests")

  // Instagram-style Follow System
  followers UserFollow[] @relation("Following")
  following UserFollow[] @relation("Followers")

  // User Posts
  userPosts UserPost[] @relation("UserPosts")
}

model RiderRank {
  id        String  @id @default(uuid())
  name      String  @unique // Beginner (0-1300), Intermediate (1301-1700), Advanced (1701+)
  minPoints Int
  maxPoints Int
  icon      String?
  users     User[]
}

model HorseTier {
  id        String  @id @default(uuid())
  name      String  @unique // Tier 1, Tier 2, etc.
  minPoints Int
  maxPoints Int
  icon      String?
  horses    Horse[]
}

model Stable {
  id               String       @id @default(uuid())
  // ownerId removed in favor of User.stableId for multi-owner support
  // But we keep a primary contact or just rely on users with this stableId
  name             String
  description      String       @db.Text
  location         String // "Giza" or "Saqqara" - validated against Location model in app logic
  address          String
  imageUrl         String? // Stable card image
  status           StableStatus @default(pending_approval)
  isHidden         Boolean      @default(false) // Admin can hide/show stables individually
  commissionRate   Decimal      @default(0.15) @db.Decimal(5, 4) // Commission rate (0.15 = 15%), can be customized per stable
  minLeadTimeHours Int          @default(8) //Minimum hours before booking (Feature 5)
  createdAt        DateTime     @default(now())
  ownerId          String // Primary owner

  // Relations
  owner             User               @relation("StableOwner", fields: [ownerId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  owners            User[]             @relation("StableOwners")
  horses            Horse[]
  bookings          Booking[]
  reviews           Review[]
  blockedSlots      BlockedSlot[]
  availabilitySlots AvailabilitySlot[]
  rideResults       RideResult[]
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model Horse {
  id                 String              @id @default(uuid())
  stableId           String
  name               String
  description        String              @db.Text
  imageUrls          String[]
  pricePerHour       Decimal?            @db.Decimal(10, 2)
  age                Int?
  skillLevel         SkillLevel          @default(BEGINNER)
  skills             String[]            @default([])
  isActive           Boolean             @default(true)
  availabilityStatus AvailabilityStatus? @default(available)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime?           @updatedAt

  // Leaderboard - Admin-locked tier (cannot be changed by stable owners)
  adminTier         String? // "Beginner", "Intermediate", "Advanced" - Only editable by admins
  firstTimeFriendly Boolean? // true = First Time Friendly, false = Not First Time Friendly, null = not set (only applicable when adminTier = "Beginner")
  rankPoints        Int        @default(1400)
  tierId            String?
  tier              HorseTier? @relation(fields: [tierId], references: [id])

  // Relations
  stable                Stable                 @relation(fields: [stableId], references: [id], onDelete: Cascade)
  bookings              Booking[]
  reviews               Review[]
  media                 HorseMedia[]
  changeRequests        HorseChangeRequest[]
  rideResults           RideResult[]
  blockedSlots          BlockedSlot[]
  availabilitySlots     AvailabilitySlot[]
  skillOverrideRequests SkillOverrideRequest[]
}

model BlockedSlot {
  id        String   @id @default(uuid())
  stableId  String
  horseId   String? // Optional: if null, blocks entire stable
  startTime DateTime
  endTime   DateTime
  reason    String?
  createdAt DateTime @default(now())

  stable Stable @relation(fields: [stableId], references: [id], onDelete: Cascade)
  horse  Horse? @relation(fields: [horseId], references: [id], onDelete: Cascade)

  @@index([stableId])
  @@index([horseId])
}

model AvailabilitySlot {
  id        String   @id @default(uuid())
  stableId  String
  horseId   String? // Optional: if null, applies to entire stable
  date      DateTime @db.Date
  startTime DateTime
  endTime   DateTime
  isBooked  Boolean  @default(false)
  bookingId String?  @unique
  createdAt DateTime @default(now())

  stable  Stable   @relation(fields: [stableId], references: [id], onDelete: Cascade)
  horse   Horse?   @relation(fields: [horseId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([stableId])
  @@index([horseId])
  @@index([date])
  @@map("availability_slots") // Force table creation
}

model RideResult {
  id           String   @id @default(uuid())
  bookingId    String   @unique
  riderId      String
  horseId      String
  stableId     String
  rps          Int // Rider Performance Score (1-10)
  pointsChange Int // Calculated points
  timestamp    DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rider   User    @relation(fields: [riderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  horse   Horse   @relation(fields: [horseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stable  Stable  @relation(fields: [stableId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([riderId])
  @@index([stableId])
}

model HorseChangeRequest {
  id      String                   @id @default(uuid())
  horseId String
  status  HorseChangeRequestStatus @default(pending)

  // Proposed changes
  proposedName         String?
  proposedDescription  String?  @db.Text
  proposedPricePerHour Decimal? @db.Decimal(10, 2)
  proposedImageUrls    String[]

  // Reviewer info
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?   @db.Text

  // Timestamps
  requestedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  horse    Horse @relation(fields: [horseId], references: [id], onDelete: Cascade)
  reviewer User? @relation("HorseChangeReviewer", fields: [reviewedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([status])
  @@index([horseId])
}

model HorseMedia {
  id           String         @id @default(uuid())
  horseId      String
  type         HorseMediaType
  url          String
  thumbnailUrl String?
  sortOrder    Int?
  createdAt    DateTime       @default(now())

  horse Horse @relation(fields: [horseId], references: [id], onDelete: Cascade)
}

enum HorseMediaType {
  image
  video
}

enum AvailabilityStatus {
  available
  injured
  unavailable
}

enum HorseChangeRequestStatus {
  pending
  approved
  rejected
}

model Booking {
  id                 String        @id @default(uuid())
  riderId            String
  stableId           String
  horseId            String
  startTime          DateTime
  endTime            DateTime
  totalPrice         Decimal
  commission         Decimal // (e.g., 20% of total)
  status             BookingStatus @default(confirmed)
  stripePaymentId    String?       @unique
  refundStatus       String? // "requested", "approved", "rejected", "processed"
  refundAmount       Decimal?
  stripeRefundId     String?
  refundReason       String?       @db.Text
  cancellationReason String?       @db.Text
  rescheduledFrom    DateTime?
  rescheduledTo      DateTime?
  isRescheduled      Boolean       @default(false)
  cancelledBy        String? // "rider", "owner", "admin"
  promoCodeId        String?
  groupSize          Int           @default(1) // Number of riders (1 = solo, 5+ = group discount)
  groupDiscount      Decimal?      @db.Decimal(10, 2) // Discount applied for groups
  reminderSent       Boolean       @default(false) // Whether 5-hour reminder email was sent
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  rider            User              @relation(fields: [riderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stable           Stable            @relation(fields: [stableId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  horse            Horse             @relation(fields: [horseId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  review           Review? // A booking can have one review
  riderReview      RiderReview? // A booking can have one rider review from stable owner
  rideResult       RideResult?
  availabilitySlot AvailabilitySlot? // The availability slot consumed by this booking
  promoCode        PromoCode?        @relation(fields: [promoCodeId], references: [id])
}

model Review {
  id           String   @id @default(uuid())
  bookingId    String   @unique // One review per booking
  riderId      String
  stableId     String
  horseId      String
  stableRating Int // 1-5
  horseRating  Int // 1-5
  comment      String   @db.Text
  photos       String[] // Array of photo URLs
  createdAt    DateTime @default(now())

  // Relations
  booking      Booking       @relation(fields: [bookingId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rider        User          @relation(fields: [riderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stable       Stable        @relation(fields: [stableId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  horse        Horse         @relation(fields: [horseId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  reviewMedias ReviewMedia[]
}

// Stable Owner reviews Riders
model RiderReview {
  id               String   @id @default(uuid())
  bookingId        String   @unique // One review per booking from owner
  riderId          String // Rider being reviewed
  ownerId          String // Stable owner writing review
  ridingSkillLevel Int // 1-10 scale for future ranking system
  behaviorRating   Int // 1-5 stars (kindness, helpfulness, respectfulness)
  comment          String?  @db.Text
  createdAt        DateTime @default(now())

  // Relations
  booking     Booking @relation(fields: [bookingId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rider       User    @relation("RiderReviews", fields: [riderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stableOwner User    @relation("StableOwnerReviews", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model NewsletterSubscriber {
  id           String   @id @default(uuid())
  email        String   @unique
  subscribedAt DateTime @default(now())
  status       String   @default("active") // "active", "unsubscribed"
  source       String? // "homepage", "footer", "checkout", etc.
}

model LoyaltyPoints {
  id           String              @id @default(uuid())
  userId       String              @unique
  points       Int                 @default(0)
  tier         String              @default("bronze") // "bronze", "silver", "gold", "platinum"
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  transactions PointsTransaction[]
}

model PointsTransaction {
  id              String        @id @default(uuid())
  loyaltyPointsId String
  loyaltyPoints   LoyaltyPoints @relation(fields: [loyaltyPointsId], references: [id], onDelete: Cascade)
  amount          Int // positive = earned, negative = redeemed
  type            String // "booking", "review", "referral", "redemption"
  description     String?
  createdAt       DateTime      @default(now())

  @@index([loyaltyPointsId])
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "CASH_RESTRICTION_ENABLED"
  value     String // "true" or "false"
  updatedAt DateTime @updatedAt
}

model Subscription {
  id             String   @id @default(uuid())
  userId         String
  planType       String // "monthly", "annual", "family"
  ridesRemaining Int? // null = unlimited
  ridesUsed      Int      @default(0)
  startDate      DateTime @default(now())
  endDate        DateTime
  isActive       Boolean  @default(true)
  price          Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// League System - Chess.com style leagues
model League {
  id        String       @id @default(uuid())
  name      LeagueName // Wood, Bronze, Silver, Gold, Platinum, Elite, Champion
  startDate DateTime
  endDate   DateTime // 2 weeks after startDate
  status    LeagueStatus @default(active)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  riders          User[]           @relation("RiderLeague")
  standings       LeagueStanding[]
  nextLeagueId    String? // ID of the next league (for promotion)
  nextLeague      League?          @relation("LeaguePromotion", fields: [nextLeagueId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  previousLeagues League[]         @relation("LeaguePromotion")

  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model LeagueStanding {
  id         String   @id @default(uuid())
  leagueId   String
  riderId    String
  rankPoints Int // Rider's rank points at the end of this league period
  finalRank  Int? // Final rank in this league (1, 2, 3, etc.)
  promoted   Boolean  @default(false) // Whether rider was promoted to next league
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rider  User   @relation(fields: [riderId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([leagueId, riderId])
  @@index([leagueId])
  @@index([riderId])
  @@index([finalRank])
}

model PromoCode {
  id             String    @id @default(uuid())
  code           String    @unique
  discountType   String    @default("percentage") // "percentage" or "fixed"
  discountAmount Decimal   @db.Decimal(10, 2)
  expiresAt      DateTime?
  maxUses        Int? // Null = unlimited
  currentUses    Int       @default(0)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  bookings Booking[]
}

// Friends System
enum FriendStatus {
  pending
  accepted
  rejected
}

model Friend {
  id         String       @id @default(uuid())
  senderId   String
  receiverId String
  status     FriendStatus @default(pending)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  sender   User @relation("FriendsSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("FriendsReceived", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}

// Chat/Messaging System
model Conversation {
  id           String    @id @default(uuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  participants User[]    @relation("ConversationParticipants")
  messages     Message[]

  @@index([updatedAt])
}

model Message {
  id             String   @id @default(uuid())
  content        String   @db.Text
  createdAt      DateTime @default(now())
  read           Boolean  @default(false)
  senderId       String
  conversationId String

  sender       User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// Skill Override Request - When rider wants to book a horse above their skill level
enum SkillRequestStatus {
  pending
  approved
  rejected
}

model SkillOverrideRequest {
  id        String             @id @default(uuid())
  riderId   String
  horseId   String
  stableId  String
  reason    String?            @db.Text
  status    SkillRequestStatus @default(pending)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  rider User  @relation("RiderSkillRequests", fields: [riderId], references: [id], onDelete: Cascade)
  horse Horse @relation(fields: [horseId], references: [id], onDelete: Cascade)

  @@index([riderId])
  @@index([horseId])
  @@index([stableId])
  @@index([status])
}

// Instagram-style Follow System
model UserFollow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// User Posts for Instagram-style profile
model UserPost {
  id        String   @id @default(uuid())
  userId    String
  imageUrl  String
  caption   String?  @db.Text
  createdAt DateTime @default(now())

  user User @relation("UserPosts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// Review Media - Photos attached to reviews
model ReviewMedia {
  id        String   @id @default(uuid())
  reviewId  String
  url       String
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}
