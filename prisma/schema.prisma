// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL") // Connects to Neon
  relationMode = "prisma"
}

enum Role {
  rider
  stable_owner
  admin
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
  rescheduled
}

enum StableStatus {
  pending_approval
  approved
  rejected
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  phoneNumber        String?   @unique
  passwordHash       String
  profileImageUrl    String?
  fullName           String?
  role               Role      @default(rider)
  hasPremiumAI       Boolean   @default(false) // Premium AI subscription (admins can grant to stable owners)
  premiumAIExpiresAt DateTime? // Subscription expiration date
  createdAt          DateTime  @default(now())

  // Relations
  bookings             Booking[]
  reviews              Review[]
  stable               Stable? // A user can own one stable
  passwordResetTokens  PasswordResetToken[]
  riderReviewsGiven    RiderReview[]        @relation("StableOwnerReviews")
  riderReviewsReceived RiderReview[]        @relation("RiderReviews")
  horseChangeReviews   HorseChangeRequest[] @relation("HorseChangeReviewer")
}

model Stable {
  id             String       @id @default(uuid())
  ownerId        String       @unique // Each stable has one owner
  name           String
  description    String       @db.Text
  location       String // "Giza" or "Saqqara"
  address        String
  imageUrl       String? // Stable card image
  status         StableStatus @default(pending_approval)
  isHidden       Boolean      @default(false) // Admin can hide/show stables individually
  commissionRate Decimal      @default(0.15) @db.Decimal(5, 4) // Commission rate (0.15 = 15%), can be customized per stable
  createdAt      DateTime     @default(now())

  // Relations
  owner    User      @relation(fields: [ownerId], references: [id])
  horses   Horse[]
  bookings Booking[]
  reviews  Review[]
}

model Horse {
  id                 String              @id @default(uuid())
  stableId           String
  name               String
  description        String              @db.Text
  imageUrls          String[]
  pricePerHour       Decimal?            @db.Decimal(10, 2)
  age                Int?
  skills             String[]            @default([])
  isActive           Boolean             @default(true)
  availabilityStatus AvailabilityStatus? @default(available)

  // Relations
  stable         Stable               @relation(fields: [stableId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  reviews        Review[]
  media          HorseMedia[]
  changeRequests HorseChangeRequest[]
}

model HorseChangeRequest {
  id      String                   @id @default(uuid())
  horseId String
  status  HorseChangeRequestStatus @default(pending)

  // Proposed changes
  proposedName         String?
  proposedDescription  String?  @db.Text
  proposedPricePerHour Decimal? @db.Decimal(10, 2)
  proposedImageUrls    String[]

  // Reviewer info
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?   @db.Text

  // Timestamps
  requestedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  horse    Horse @relation(fields: [horseId], references: [id], onDelete: Cascade)
  reviewer User? @relation("HorseChangeReviewer", fields: [reviewedBy], references: [id])

  @@index([status])
  @@index([horseId])
}

model HorseMedia {
  id           String         @id @default(uuid())
  horseId      String
  type         HorseMediaType
  url          String
  thumbnailUrl String?
  sortOrder    Int?
  createdAt    DateTime       @default(now())

  horse Horse @relation(fields: [horseId], references: [id], onDelete: Cascade)
}

enum HorseMediaType {
  image
  video
}

enum AvailabilityStatus {
  available
  injured
  unavailable
}

enum HorseChangeRequestStatus {
  pending
  approved
  rejected
}

model Booking {
  id                 String        @id @default(uuid())
  riderId            String
  stableId           String
  horseId            String
  startTime          DateTime
  endTime            DateTime
  totalPrice         Decimal
  commission         Decimal // (e.g., 20% of total)
  status             BookingStatus @default(confirmed)
  stripePaymentId    String?       @unique
  refundStatus       String? // "requested", "approved", "rejected", "processed"
  refundAmount       Decimal?
  stripeRefundId     String?
  refundReason       String?       @db.Text
  cancellationReason String?       @db.Text
  rescheduledFrom    DateTime?
  rescheduledTo      DateTime?
  isRescheduled      Boolean       @default(false)
  cancelledBy        String? // "rider", "owner", "admin"
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  rider       User         @relation(fields: [riderId], references: [id])
  stable      Stable       @relation(fields: [stableId], references: [id])
  horse       Horse        @relation(fields: [horseId], references: [id])
  review      Review? // A booking can have one review
  riderReview RiderReview? // A booking can have one rider review from stable owner
}

model Review {
  id           String   @id @default(uuid())
  bookingId    String   @unique // One review per booking
  riderId      String
  stableId     String
  horseId      String
  stableRating Int // 1-5
  horseRating  Int // 1-5
  comment      String   @db.Text
  createdAt    DateTime @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id])
  rider   User    @relation(fields: [riderId], references: [id])
  stable  Stable  @relation(fields: [stableId], references: [id], onDelete: Restrict)
  horse   Horse   @relation(fields: [horseId], references: [id], onDelete: Restrict)
}

// Stable Owner reviews Riders
model RiderReview {
  id               String   @id @default(uuid())
  bookingId        String   @unique // One review per booking from owner
  riderId          String // Rider being reviewed
  ownerId          String // Stable owner writing review
  ridingSkillLevel Int // 1-10 scale for future ranking system
  behaviorRating   Int // 1-5 stars (kindness, helpfulness, respectfulness)
  comment          String?  @db.Text
  createdAt        DateTime @default(now())

  // Relations
  booking     Booking @relation(fields: [bookingId], references: [id])
  rider       User    @relation("RiderReviews", fields: [riderId], references: [id])
  stableOwner User    @relation("StableOwnerReviews", fields: [ownerId], references: [id])
}

model NewsletterSubscriber {
  id           String   @id @default(uuid())
  email        String   @unique
  subscribedAt DateTime @default(now())
  status       String   @default("active") // "active", "unsubscribed"
  source       String? // "homepage", "footer", "checkout", etc.
}

model LoyaltyPoints {
  id        String   @id @default(uuid())
  userId    String   @unique
  points    Int      @default(0)
  tier      String   @default("bronze") // "bronze", "silver", "gold", "platinum"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}
